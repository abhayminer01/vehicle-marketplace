<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile | Wheelzy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    #bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Video Background -->
  <video autoplay muted loop id="bg-video">
    <source src="./MUSTANG.mp4" type="video/mp4">
  </video>

  <!-- Navbar -->
  <nav class="absolute top-0 left-0 w-full z-20 bg-white/10 backdrop-blur-md border-b border-white/20">
    <div class="container mx-auto px-6">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="flex items-center space-x-2">
          <svg class="h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/>
            <circle cx="7" cy="17" r="2"/>
            <path d="M9 17h6"/>
            <circle cx="17" cy="17" r="2"/>
          </svg>
          <span class="text-2xl font-bold text-white drop-shadow-lg">Wheelzy</span>
        </div>

        <!-- Nav links -->
        <div class="flex items-center space-x-6">
          <a href="./index.html" class="text-white hover:text-blue-400 font-medium transition">Home</a>
          <a href="#vehicles" class="text-white hover:text-blue-400 font-medium transition">Vehicles</a>
          <a href="#about" class="text-white hover:text-blue-400 font-medium transition">About</a>

          <!-- Logout Button -->
          <button id="logoutBtn"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
            Logout
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Profile Section -->
  <main class="flex-grow px-6 pt-24 relative z-10">
    <div
      class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl shadow-lg p-8 w-full max-w-md text-center mx-auto">
      
      <!-- Avatar -->
      <div class="flex justify-center mb-6">
        <div class="w-24 h-24 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center text-white text-3xl font-bold">
          U
        </div>
      </div>

      <!-- User Info -->
      <h2 id="fullname" class="text-2xl font-bold text-white">John Doe</h2>
      <p id="email" class="text-gray-300">johndoe@email.com</p>
      <p id="phone" class="text-gray-400 mt-2">+91 98765 43210</p>

      <!-- Edit Button -->
      <button id="editBtn" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        Edit Profile
      </button>
    </div>

    <!-- Favorites Section -->
    <section class="mt-12 max-w-4xl mx-auto bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl shadow-lg p-6">
      <h3 class="text-xl font-bold text-white mb-4">‚≠ê Favorites</h3>
      <div id="favoritesList" class="grid gap-4 md:grid-cols-2"></div>
    </section>

    <!-- My Listings Section -->
    <section class="mt-12 max-w-4xl mx-auto bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl shadow-lg p-6">
      <h3 class="text-xl font-bold text-white mb-4">üöó My Listings</h3>
      <div id="listingsList" class="grid gap-4 md:grid-cols-2"></div>
    </section>
  </main>

  <!-- Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md p-6 relative">
      <h2 class="text-xl font-bold mb-4">Edit Profile</h2>

      <form id="editForm" class="space-y-4">
        <input type="text" id="editFullname" placeholder="Full Name"
          class="w-full px-4 py-2 border rounded-lg focus:ring focus:ring-blue-400"/>

        <input type="email" id="editEmail" placeholder="Email"
          class="w-full px-4 py-2 border rounded-lg focus:ring focus:ring-blue-400"/>

        <input type="text" id="editPhone" placeholder="Phone Number"
          class="w-full px-4 py-2 border rounded-lg focus:ring focus:ring-blue-400"/>

        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelEdit" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let userData = {};

    window.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');

      try {
        // Get user profile
        const res = await axios.get('http://localhost:5000/api/users/profile', {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (res.data.success) {
          userData = res.data.data;
          const { fullname, email, phone } = userData;

          document.getElementById('fullname').innerText = fullname;
          document.getElementById('email').innerText = email;
          document.getElementById('phone').innerText = phone;
        }

        // Fetch favorites
        const favRes = await axios.get('http://localhost:5000/api/users/favorites', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (favRes.data.success) renderVehicles(favRes.data.data, "favoritesList");

        // Fetch listings
        const listRes = await axios.get('http://localhost:5000/api/users/listings', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (listRes.data.success) renderVehicles(listRes.data.data, "listingsList");

      } catch (error) {
        console.error('Error fetching profile:', error);
        alert("Session expired, please login again!");
        // location.href = "./login.html";
      }
    });

    // Render vehicles function
    function renderVehicles(vehicles, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = vehicles.length ? "" : "<p class='text-gray-300'>No vehicles found.</p>";

      vehicles.forEach(v => {
        const card = document.createElement("div");
        card.className = "bg-white/20 rounded-lg p-4 shadow-md";
        card.innerHTML = `
          <h4 class="text-lg font-bold text-white">${v.make} ${v.model}</h4>
          <p class="text-gray-300">${v.year} ‚Ä¢ ${v.price} USD</p>
        `;
        container.appendChild(card);
      });
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = './login.html';
    });

    // Open Edit Modal
    document.getElementById('editBtn').addEventListener('click', () => {
      document.getElementById('editFullname').value = userData.fullname || '';
      document.getElementById('editEmail').value = userData.email || '';
      document.getElementById('editPhone').value = userData.phone || '';
      document.getElementById('editModal').classList.remove('hidden');
    });

    // Cancel Edit
    document.getElementById('cancelEdit').addEventListener('click', () => {
      document.getElementById('editModal').classList.add('hidden');
    });

    // Save Edit
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = localStorage.getItem('token');

      const updatedData = {
        fullname: document.getElementById('editFullname').value,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value
      };

      try {
        const res = await axios.put('http://localhost:5000/api/users/profile', updatedData, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (res.data.success) {
          alert("Profile updated successfully!");
          localStorage.setItem('token', res.data.token);
          window.location.reload();
        }
      } catch (error) {
        console.error("Error updating profile:", error);
        alert("Error updating profile. Try again!");
      }
    });
  </script>
</body>
</html>
